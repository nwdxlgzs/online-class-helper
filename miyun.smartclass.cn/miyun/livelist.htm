

<!DOCTYPE html>

<html lang="zh-CN">
<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><link rel="icon" href="../favicon.ico" type="image/x-icon" /><link rel="shortcut icon" href="../favicon.ico" type="image/x-icon" /><link id="gray_css" rel="stylesheet" /><link href="../Css/font-awesome.min.css" rel="stylesheet" />
    <!--[if IE]>
         <link id="gray_css_IE" rel="stylesheet" />
        <![endif]-->
    <title>

</title>
<link rel="stylesheet" href="../Js/plug-in/share_to_society/share.min.css" /><link rel="stylesheet" type="text/css" href="../Css/z-treeCss/metroStyle/metroStyle.css" /><link rel="stylesheet" type="text/css" href="../Css/basePc.css" /><link rel="stylesheet" type="text/css" href="../Css/common.css" /><link rel="stylesheet" type="text/css" href="../Css/all.css" /><link rel="stylesheet" type="text/css" href="../Css/other.css" /><link rel="stylesheet" type="text/css" href="../Css/miyun.css" /><link rel="stylesheet" type="text/css" href="../Js/plug-in/jquery-easyui-1.5.1/theme/material/easyui.css" /><link rel="stylesheet" type="text/css" href="../Js/plug-in/jquery-easyui-1.5.1/theme/icon.css" /><link rel="stylesheet" type="text/css" href="../Js/plug-in/select2/select2.min.css" /><link rel="stylesheet" type="text/css" href="../Css/font-awesome.min.css" />
    <script type="text/javascript" src="../Js/xphter.js"></script>
    <script type="text/javascript" src="../Js/jquery-1.11.2.js"></script>
    <script type="text/javascript" src="../Js/plug-in/jquery.tmpl.min.js"></script>
    <script type="text/javascript" src="../Js/AjaxUrl.js"></script>
    <script type="text/javascript" src="../js/plug-in/paging-master/src/query.js"></script>
    <script type="text/javascript" src="../js/plug-in/paging-master/src/paging.js"></script>
    <script type="text/javascript" src="../js/plug-in/layer/layer.js"></script>
    <script type="text/javascript" src="../Js/plug-in/select2/select2.full.js"></script>

    <script type="text/javascript" src="../Js/mainFunction.js"></script>
    <script type="text/javascript" src="../Js/popOrganSelect.js"></script>
    <script type="text/javascript" src="../Js/plug-in/jquery-easyui-1.5.1/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../Js/plug-in/jquery-easyui-1.5.1/locale/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="../Js/My97DatePicker/WdatePicker.js"></script>
    
    <script type="text/javascript" src="../Js/allCommon.js"></script>
    <script src="../Js/plug-in/share_to_society/jquery.share.min.js"></script>
    <style>
        .panel-body {
            padding: 0 !important;
        }

        .combo-panel {
            overflow: hidden;
        }

        .publicHeader .fheader .personal_info ul {
            width: 500px;
        }

        .publicFootInfo li {
            float: none;
            text-align: center;
            color: #fff;
            height: 30px;
            line-height: 30px;
        }

        .copyright {
            display: inline-block;
            vertical-align: top;
            color: #fff;
            margin-left: 5px;
        }

        .footImg {
            width: 30px;
            height: 30px;
        }
        .publicHeader .fheader .personal_info .login_area{
            display:inline-block;
        }
    </style>
</head>
<body>
    <div style="height: 86px;">
        <div class="publicHeader">
            <div class="fheader ">
                <div class="content_wrap clearfix">
                    <div class="company_logo fl">
                        <a href="index.htm"><img src="../images/miyun/miyunlogo.png" /></a>
                    </div>
                    <div class="middle_nav fl">
                        <ul class="clearfix webNavWrap">
                            <li class="defaultPage"><a href="index.htm" class="first_nav webNav webNav_1 ">首页</a></li>
                            <li class="livePage"><a href="livelist.htm" class="first_nav webNav webNav_2">直播课堂</a></li>
                            <li class="videoPage"><a href="videolist.htm" class="first_nav webNav webNav_3">课程回放</a></li>
                            <li class="Statistics hidee"><a href="Statistics.htm" class="first_nav webNav webNav_4">数据统计</a></li>
                            <li class="personal_space hidee"><a href="livelist.htm#" class="first_nav webNav webNav_4" id="self_space_wrap">个人空间
                            <span class="choose_nav"></span>
                                <img src="../images/broadcastlive_14.png" class="first_nav_img" /></a>
                                <div class="second_nav">
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div class="personal_info fr">
                        <ul class="clearfix">
                            <li class="personal_img hidee">
                                <a href="livelist.htm#">
                                    <img id="user_images" src="livelist.htm" onerror="nofindPic('/images/broadcastlive_06.png',null,event)" /><span id="user_name"></span> </a>
                                <div class="quit_area self_nav_wrap hidee">
                                    <a class="editPsw_item">修改密码</a>
                                    
                                    <a class="quit_item">退出</a>
                                </div>
                            </li>
                            <li class="login_area">
                                <a href="livelist.htm#"><span>登录</span></a>
                            </li>
                            <li class="enter_backstage hidee"><a href="livelist.htm#"><span>进入后台</span></a></li>
                            
                            <li class="downloadLiveExe"><a href="http://miyun.smartclass.cn/software/liveclient.exe"><i class="fa fa-camera"></i>直播客户端下载</a></li>
                            <li class="onlinePhone"><b>客服电话</b>
                                <span class="closeOnlinePhone hidee"></span>
                                <div class="blackboard hidee">
                                    <img src="images/blackboard.png" />
                                </div>
                            </li>
                            
                        </ul>
                    </div>
                </div>
            </div>
            <div class="selfSpaceHeaderShadow"></div>
        </div>
    </div>
    <div class="middle_content_wrap">
        <script type="text/javascript">
            var userInfo = [{"UserID":0}];
            var strCookie = userInfo[0].UserID;

            $(function () {
                middleContentHeight();//页面高度计算
                $(window).resize(function () {//页面窗口变化重新高度计算
                    middleContentHeight();
                })

                //固定导航
                $(window).scroll(function () {
                    var scrollTop = $(this).scrollTop();//滚动条的偏移量
                    var scrollHeight = $(document).height();//页面的总高度
                    var windowHeight = $(this).height();//浏览器可见区域的高度
                    if (scrollTop > 0) {
                        $(".publicHeader").css({
                            "position": "fixed",
                            "z-index": 99,
                            "top": 0
                        })
                    } else if (scrollTop == 0) {
                        $(".publicHeader").css({
                            "position": "static",
                            "z-index": 99
                        })
                    };
                })
                //置灰
                //setGray();
            })
        </script>
        <script type="text/javascript" src="../Js/masterPages.js"></script>
        
    <link rel="stylesheet" type="text/css" href="http://miyun.smartclass.cn/Js/plug-in/uploadImg-master/uploadImg.css" />
    <script type="text/javascript" src="http://miyun.smartclass.cn/Js/plug-in/ueditor1_4_3_3/ueditor.config.js"></script>
    <script type="text/javascript" src="http://miyun.smartclass.cn/Js/plug-in/ueditor1_4_3_3/ueditor.all.js"></script>
    <script type="text/javascript" charset="utf-8" src="http://miyun.smartclass.cn/Js/plug-in/ueditor1_4_3_3/lang/zh-cn/zh-cn.js"></script>
    <style>
        .memoIcon {
            position: relative;
            cursor: pointer;
        }

            .memoIcon .memoWrap {
                position: absolute;
                width: 260px;
                height: 100px;
                overflow: auto;
                border: 1px solid #ccc;
                background-color: #eee;
                top: 20px;
                left: 0;
                display: none;
            }

            .memoIcon:hover .memoWrap {
                display: block;
            }

        .middle_content_wrap {
            padding-top: 15px;
        }

        .vClassSelectTopBtn {
            float: right !important;
            margin-right: 45px !important;
        }

        .videoClassSelectBtm .newLiveBtn {
            margin: 14px 44px 0 0;
            width: 100px;
            height: 30px;
            background: #6ec3ca;
            color: #fff;
            text-align: center;
            line-height: 30px;
            border-radius: 15px;
            float: right;
            cursor: pointer;
            display: none;
        }
        /*弹窗直播 录播  公开直播 样式*/
        .isLabelIcon, .isVideoPublic {
            height: 18px;
            display: inline-block;
            width: 45px;
            vertical-align: middle;
            box-sizing: border-box;
            background-image: url('/Images/publicImg/label_close.png');
            cursor: pointer;
        }

        .isVideoPublic,
        .pop_input #isVideo,
        .pop_input #isLive,
        .pop_input #isLiveOpen {
            visibility: hidden;
        }

        .pop_InfoHead {
            background-color: #FBFBFB;
            border-bottom: 1px solid #eee;
        }

        .pop_InfoHead img {
            margin-bottom: -1px;
            margin-right: 10px;
        }

        .baseInfoHead, .videoIndoHead, .RtmpInfoHead {
            cursor: pointer;
            font-weight: 900;
            padding: 5px;
        }

        .RtmpInfoHead {
            width: 184px;
            text-align: left;
            margin-left: 46px;
        }

        input[name=ISAddAllClass] {
            vertical-align: middle;
            width: 15px;
            height: 15px;
            margin-right: 5px;
        }

        .CourseGradeWrap span {
            vertical-align: middle;
        }

        .CourseWrap {
            width: 350px;
        }

        .distance_to_live_start_time {
            margin-left: 10px;
            font-size: 14px;
            color: #999;
            font-weight: bold;
            overflow: hidden;
            /*width: 190px;*/
        }
    </style>
    <!--直播课堂-->
    <div class="videoClassWrap">
        <div class="videoClassTitle hidee">
            <p class="videoClassTitleCxt">
                <b></b>
                <a href="livelist.htm#" id="all-live" class="vClassTitleItem vClassTitleItemActive">所有直播</a>
                <b></b>
                <a href="livelist.htm#" id="my-live" class="vClassTitleItem">与我相关</a>
                <b></b>
                <a href="livelist.htm#" id="open-live" class="vClassTitleItem">公开直播</a>
                <b></b>
            </p>
        </div>

        <!--主体内容：用户选择 课程显示 页码区域-->
        <div class="publicContainer">
            <!--主体内容二：用户选择项-->
            <div class="videoClassSelect liveClassSelect">
                <div class="videoClassSelectWrap">
                    <ul class="videoClassSelectTop clearFloat">
                        <li class="vClassSelectTopItem">
                            <label for="videoTheme" class="Vmiddle"><span>标题：</span></label>
                            <div class="inlineBlock">
                                <input name="videoTheme" id="videoTheme" type="text" />
                            </div>
                        </li>
                        <li class="vClassSelectTopItem schoolListWrap hidee">
                            <label for="schoolList" class="Vmiddle"><span>学校：</span></label>
                            <div class="inlineBlock  selectDiv">
                                <div class="combogride_wrap">
                                    <input id="schoolList" />
                                </div>
                                <input type="hidden" id="schoolListKey" />
                            </div>
                        </li>
                        <li class="vClassSelectTopItem selectMenuWrap gradeListWrap hidee">
                            <label for="gradeList" class="Vmiddle"><span>年级：</span></label>
                            <div class="inlineBlock  selectDiv">
                                <div class="combogride_wrap">
                                    <input id="gradeList" editable="false"/>
                                </div>
                                <input type="hidden" id="gradeListKeyword" />
                            </div>
                        </li>

                        <li class="vClassSelectTopItem selectMenuWrap ">
                            <label for="selectSubject" class="Vmiddle"><span>学科：</span></label>
                            <div class="inlineBlock selectSubjectWrap selectDiv">
                                <div class="combogride_wrap">
                                    <input id="selectSubject" />
                                </div>
                                <input type="hidden" id="selectSubjectword" />
                            </div>
                        </li>
                        <li class="vClassSelectTopItem selectMenuWrap  courseListWrap">
                            <label for="videoCourse" class="Vmiddle"><span>课程：</span></label>
                            <div class="inlineBlock videoCourseWrap selectDiv">
                                <div class="combogride_wrap">
                                    <input id="videoCourse" />
                                </div>
                                <input type="hidden" id="courseKeyword" />
                            </div>
                        </li>
                        <li class="vClassSelectTopItem teacherWrap">
                            <label for="listTeach" class="Vmiddle"><span>主讲：</span></label>
                            <div class="inlineBlock listTeachWrap selectDiv">
                                <div class="combogride_wrap">
                                    <input id="listTeach" />
                                </div>
                                <input type="hidden" id="listTeachKey" />
                            </div>
                        </li>
                        <!--开始日期和结束日期的插件-->
                        <li class="inline calendarWrap videoPlanDate" style="position: relative; top: 1px;">
                            <div class="inlineBlock dateDiv">
                                <input id="startDT1" class="Wdate" type="text" style="width: 120px;" onclick="WdatePicker({ el: this, dateFmt: 'yyyy-MM-dd' })" />
                            </div>
                            <span>-</span>
                            <div class="inlineBlock dateDiv">
                                <input id="endDT1" class="Wdate" type="text" style="width: 120px;" onclick="WdatePicker({ el: this, dateFmt: 'yyyy-MM-dd' })" />
                            </div>
                        </li>
                        <li class="vClassSelectTopBtn">
                            <div class="inlineBlock" style="position: relative; top: 1px; top: 4px\9">
                                <input type="button" value="查询" id="query_btn" />
                                <input type="button" value="重置" id="reset_btn" />
                            </div>
                        </li>
                    </ul>
                    <ul class="videoClassSelectBtm clearFloat">
                        <li class="vClassSelectBtmOrder">排序：
                        </li>
                        <li class="vClassSelectBtmOrderCxt vClassSelectBtmItem" style="width: 136px;">
                            <a id="vClassSeeNum" class="vClassSeeNumTop" href="livelist.htm#">观看次数</a>
                            <a id="vClassSeeTime" class="vClassSeeTimeTop" href="livelist.htm#">开始时间</a>
                        </li>
                        
                        <li class="vClassSelectBtmTime vClassSelectBtmItem allOpen-btmClick">
                            <a id="live_Tall" class="allSelect " href="livelist.htm#">全部</a>
                            |
                            <a id="live_Ting" class="allSelect vClassSelectBtmActive" href="livelist.htm#">正在直播</a>
                            |
                            <a id="live_T" href="livelist.htm#" class="allSelect">即将开始</a>
                            |
                            <a id="live_Ted" href="livelist.htm#" class="allSelect">直播回放</a>
                        </li>
                        
                        <li class="vClassSelectBtmTime vClassSelectBtmItem my-btmClick ">
                            <a id="live_like" href="livelist.htm#" class="mySelect">我的点赞</a>
                            |
                            <a id="live_save" href="livelist.htm#" class="mySelect">我的收藏</a>
                        </li>
                        <li class="fr newLiveBtn ">新建直播</li>
                    </ul>
                </div>
            </div>
            <!--主体内容三：课程显示区域-->
            <div class="videoClassBody">
            </div>
            <!--增加分页插件-->
            <div id="pageToolbar" class="pageGap"></div>
            <div id="tips"></div>
        </div>
    </div>
    <div id="AddHtml" class="hidee">
        <form method="post" enctype="multipart/form-data" autocomplete="off">
            <input type="hidden" name="IsThirdPartyTargetLive" value="true" />
            <input type="hidden" name="SchoolID" />
            <input type="hidden" name="ScheduleID" />
            <input type="hidden" name="HasImage" />
            <input type="hidden" name="IsPublicVideo" value="false" />
            <input type="hidden" name="IsPublishVideo" value="true" />
            <input type="hidden" name="IsNeedRecord" value="true" />
            <input type="hidden" name="IsNeedLive" value="true" />
            <input type="hidden" name="IsPublicLive" value="false" />

            <div class="pop_input pop_InfoHead">
                <span class="attribute_name baseInfoHead">
                    <img src="http://miyun.smartclass.cn/Images/publicImg/info_down.png" />基本信息</span>
            </div>
            <div class="baseInfoBody">
                <div class="pop_input"><span class="attribute_name"><i class="rice"></i>直播服务</span><select id="c01-select" class="select2" name="LiveStreamProviderID"></select></div>
                <div class="pop_input"><span class="attribute_name"><i class="rice"></i>标题</span><input name="Title" type="text" class="rightContent popTheme" /></div>
                <div class="pop_input">
                    <span class="attribute_name"><i class="rice"></i>学校</span>
                    <div class="inlineBlock schoolWrap">
                        <div class="combogride_wrap">
                            <input id="schooleList" />
                        </div>
                        <input type="hidden" id="schooleListKey" />
                    </div>
                </div>
                
                <input type="hidden" name="TeacherList" />
                <div class="pop_input teachers_list_wrap_row items_list_wrap_row hidee">
                    <span class="attribute_name"><i class="rice"></i>已选主讲</span><div class="teachers_list_wrap items_list_wrap  hidee"></div>
                </div>
                <div class="pop_input">
                    <span class="attribute_name"><i class="rice"></i>主讲</span>
                    <div class="inlineBlock SpeakerWrap" style="width: 600px;">
                        <p id="main_speaker_show"></p>
                        <div class="combogride_wrap">
                            <input id="speakerg" name="TeacherID" />
                        </div>
                        <div class="addbtns" style="display: inline-block; vertical-align: middle;">+</div>
                        <i id="teacherListWarning" class="rice grade_attention hidee">请完善信息</i>
                        <input type="hidden" id="speakerKey" />
                    </div>
                </div>
                <div class="pop_input">
                    <span class="attribute_name"><i class="rice"></i>课程</span>
                    <div class="inlineBlock CourseWrap">
                        <div class="combogride_wrap">
                            <input id="courseg" name="CourseID" />
                        </div>
                        <i id="courseWarning" class="rice grade_attention hidee">请完善信息</i>
                        <input type="hidden" id="courseKey" />
                    </div>
                </div>
                <div class="pop_input">
                    <span class="attribute_name"><i class="rice">*</i>起止时间</span>
                    <input id="startTimes" type="text" class="hidee" />
                    <input id="showStart" type="hidden" name="StartTime" validate-options="nullable:false,warningID:'startTimeWarning'" />
                    <div class="inlineBlock startDiv">
                        <input id="startDT" class="Wdate" type="text" onclick="WdatePicker({ el: this, dateFmt: 'yyyy-MM-dd HH:mm', onpicked: startPicked1, oncleared: startClear })" />
                    </div>
                    <span>&nbsp;--&nbsp;</span>
                    <input id="endTimes" type="text" class="hidee" />
                    <input id="showEnd" type="hidden" name="StopTime" validate-options="nullable:false,warningID:'endDateWarning'" />
                    <div class="inlineBlock endDiv">
                        <input id="endDT" class="Wdate" type="text" onclick="WdatePicker({ el: this, dateFmt: 'yyyy-MM-dd HH:mm', onpicked: endPicked1, oncleared: endClear })" />
                    </div>
                    <i id="startTimeWarning" class="rice accunt_attention hidee">请完善信息</i>
                    <i id="endDateWarning" class="rice accunt_attention hidee">请完善信息</i>
                </div>
                <div class="OfficeWrap hidee">
                    <div class="pop_input">
                        <span class="attribute_name"><i class="rice"></i>院系/专业</span>
                        <select class="organ-select popSelect"></select>
                        <i class="rice OfficeName">&nbsp;&nbsp;</i><input class="addOffice hidee" value="增加院系专业" type="button" />
                    </div>
                </div>
                <div class="pop_input grades_list_wrap_row hidee">
                    <span class="attribute_name"><i class="rice"></i>已选年级</span><div class="grades_list_wrap items_list_wrap "></div>
                </div>
                <div class="pop_input">
                    <span class="attribute_name"><i class="rice"></i>年级</span>
                    <div class="inlineBlock GradeWrap">
                        <div class="combogride_wrap">
                            <input id="selectGrade" />
                            <input type="hidden" />
                        </div>
                    </div>
                </div>
                <div class="pop_input">
                    <span class="attribute_name"><i class="rice"></i></span>
                    <div class="inlineBlock CourseGradeWrap">
                        <span>当前所选的年级，全区该年级都可观看此直播</span>
                    </div>
                </div>
                <div class="pop_input"><span class="attribute_name"><i class="rice"></i>应到人数</span><input name="StudentCount" type="text" class="rightContent stuNum" validate-options="rule:'CheckstuNum',warningID:'stuNumWarning'" /><i id="stuNumWarning" class="rice name_attention hidee">请输入正数！</i><i id="stuCxt" class="rice name_attention">若不填写，以所选的班级和学生人数为准！</i></div>
                <div class="pop_input classes_list_wrap_row hidee">
                    <span class="attribute_name"><i class="rice"></i>已选班级</span><div class="classes_list_wrap items_list_wrap "></div>
                </div>
                <div class="pop_input">
                    <span class="attribute_name"><i class="rice"></i>班级</span>
                    <div class="inlineBlock ClassWrap">
                        <div class="combogride_wrap">
                            <input id="classg" name="ClassID" />
                        </div>
                        <input type="hidden" id="hdKeyword" />
                        <i id="classesWarning" class="rice grade_attention hidee">该班级当前时间不空闲</i>
                    </div>
                </div>
                <div class="pop_input students_list_wrap_row hidee">
                    <span class="attribute_name"><i class="rice"></i>已选学生</span><div class="students_list_wrap items_list_wrap hidee"></div>
                </div>
                <div class="pop_input">
                    <input id="studentList" name="StudentList" type="hidden" />
                    <span class="attribute_name"><i class="rice"></i>学生</span>
                    <div class="inlineBlock StudentWrap">
                        <div class="combogride_wrap">
                            <input id="studentg" name="StudentID" />
                        </div>
                        <input type="hidden" id="studentKeyword" />
                        <i id="studentWarning" class="rice grade_attention hidee">该学生当前时间不空闲</i>
                    </div>
                </div>
                
                <div class="pop_input">
                    <span class="attribute_name" style="vertical-align: top;"><i class="rice"></i>直播封面</span>
                    <div class="picBox"></div>
                </div>
                <div class="pop_input"><span class="attribute_name vertical_top"><i class="rice"></i>简介</span><textarea name="Summary" class="description"></textarea></div>
            </div>
        </form>
    </div>
    <script type="text/javascript">
        var submitForm = null;
        //获取当前用户信息
        var userData = userInfo[0],
         UserType = userData.UserType,
         CurrentSchoolID = userData.SchoolID,
         weekName = ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"],
         nowPageNumber = 1;
        function startPicked1() {
            $dp.$('showStart').value = $dp.$("startDT").value;
        }

        function endPicked1() {
            $dp.$("showEnd").value = $dp.$('endDT').value;
        }
        //var PhaseList = [];
        //if (userInfo[0].SchoolID && typeof userInfo[0].SchoolID != 'undefined') {
        //    Ajax.ajax({
        //        url: AjaxUrls.SchoolUrl.QuerySchool,
        //        data: { SchoolID: userInfo[0].SchoolID },
        //        async: false
        //    }).done(function (data) {
        //        PhaseList = data.PhaseList;
        //    })
        //};
        var timerArr;
        $(function () {
            var alertBoxHtml = "<div id='pop_wrap' class='marginTopCss'>" + $("#AddHtml").html() + "</div>";
            var part1Html = $(".part1").html();
            $("#AddHtml").remove();

            //直播课堂高亮显示
            $(".webNavWrap .livePage").addClass("choose_nav").siblings("li").removeClass("choose_nav");
            //判断是否登录
            if (strCookie != 0) {//用户已经登录--判断用户类型是否为系统管理员（状态等同未登录）
                MiyunSubjectSearchListSelect("selectSubject", "selectSubjectword", "");

                if (UserType == 1 || UserType == 0) {//系统管理员和老师才能创建直播
                    //学校初始化联动 ,年级初始化,班级初始化，课程初始化
                    $(".schoolListWrap").show();
                    $(".gradeListWrap").show();
                    MiyunSchoolSearchListAndGradeSelect("schoolList", "schoolListKey", { 'SchoolID': userInfo[0].SchoolID, 'SchoolName': userInfo[0].SchoolName }, true, true);
                    //selectSchoolGrade("gradeList", PhaseList);
                    $(".newLiveBtn").show();
                } else {
                    //CourseListSelect("videoCourse", "courseKeyword", "", userInfo[0].SchoolID);
                    CourseListSelect("videoCourse", "courseKeyword", "", "");
                    MiyunlistTeacherSearch("listTeach", "listTeachKey", "", userInfo[0].SchoolID);

                    $(".newLiveBtn").remove();
                    $(".schoolListWrap").remove();
                    $(".gradeListWrap").remove();
                };
            } else {//没有登录隐藏导航栏、查询项
                $(".videoClassTitle,.videoClassSelect").addClass("hidee");
            };

            showLiveList("", "", "", "10", "1", "0", null, null, null, null, null, null, null, null, null, null, true, null, null, false, null, "StartTime", 0, null, null, true);


            //列表项的 图片 标题 进入课程主页或播放页面
            $(".videoClassBody").delegate(".imgClick", "click", enterPlayPage);
            $(".videoClassBody").delegate(".h4Click", "click", enterPlayPage);
            $(".videoClassBody").delegate(".liveStateA", "click", enterPlayPage);

            $(".newLiveBtn").click(function () {
                Ajax.ajax({
                    url: AjaxUrls.ScheduleUrl.GetThirdPartyService
                }).done(function (response) {
                    alertbox();
                    var resArr = $.map(response, function (obj, index) {
                        obj.id = obj.Key;
                        obj.text = obj.Value
                        return obj;
                    });

                    //初始化 下拉框
                    Select2.SelectPicker({
                        obj: $("#c01-select"),
                        data: resArr,
                        allowClear: false
                    });

                    SchoolSearchAndCreateSchedule("schooleList", "schooleListKey", { "SchoolID": CurrentSchoolID, "SchoolName": userInfo[0].SchoolName })
                    //表单--显示学校id 课表id
                    $("#pop_wrap form input[name='SchoolID']").val(CurrentSchoolID);
                    $("#pop_wrap form input[name='ScheduleID']").val(0);
                    //主讲班级课程
                    if (typeof CurrentSchoolID != "undefined") {
                        UserIPMiYun();
                        //学生下拉
                        SchedulePopStudentSelect("studentg", "studentKeyword", "", CurrentSchoolID);
                        //主讲添加
                        var defaultTeacher;
                        if (userData.UserType == 1) {
                            defaultTeacher = {
                                "TeacherList": [{ "TeacherID": userData.ID, "TeacherName": userData.Name, "IsMajor": true }]
                            };
                        };
                        teacherInputEdit(defaultTeacher);
                    };

                    $(".students_list_wrap ").on("click", ".delete", function () {
                        $(this).parent().remove();
                        if ($(".students_list_wrap_row .students_item_wrap").length == 0) {
                            $(".students_list_wrap_row ").hide();
                        };
                    })

                    //年级
                    PopGradeSelectNoValidate("selectGrade", "", "");
                    $(".grades_list_wrap_row ").on("click", ".delete", function () {
                        $(this).parent().remove();
                        if ($(".grades_list_wrap_row .items_item_wrap").length == 0) {
                            $(".grades_list_wrap_row ").hide();
                        };
                    })

                    //获取图片格式
                    imagesFormatting();
                })
            })

            function alertbox() {
                var popHg = popHeight(900);
                Dialogue.LayerFullScreen({
                    title: '新建直播',
                    area: ['880px', popHg],
                    btn: ['确定', '取消'],
                    btnAlign: 'c',
                    anim: 2,
                    content: alertBoxHtml,
                    yes: function () {
                        if ($.trim($("#showStart").val()).length == 0 || $.trim($("#showEnd").val()).length == 0) {
                            Dialogue.Msg("请输入起止时间");
                            return;
                        };
                        var timeGap = new Date($("#showEnd").val()) - new Date($("#showStart").val());//毫秒时间差
                        if (timeGap <= 0) {
                            Dialogue.Msg("开始时间不可以大于结束时间");
                            return;
                        };

                        var courseId = parseInt($("#courseg").val());
                        if (typeof courseId != 'number' || courseId == 0) {
                            $("#courseWarning").show();
                            return;
                        } else {
                            $("#courseWarning").hide();
                        };
                        //HasImage参数赋值
                        var files = document.getElementById("plugin_files").value;
                        (files != '') ? $("input[name='HasImage']").val("true") : $("input[name='HasImage']").val("false");

                        //课程
                        formTxtName("courseg", "CourseWrap", "CourseName");

                        //班级表单提交--多选
                        $("#pop_wrap .ClassWrap .textbox-value").remove();
                        //组织机构表单提交
                        organForm("OrganizationID");

                        //班级验证
                        if (!checkSelectClasses()) {
                            return;
                        };
                        //学生提交
                        studentsSubmit();
                        var checkStudentsFlag = checkSelectStudents();
                        //主讲验证和提交
                        if (checkStudentsFlag) {
                            majorTeacherSelect(0, null, true, null, true);
                        };
                    }
                })
                //课程表表单
                window.setTimeout(function () {
                    submitForm = InitializeValidatedForm(AjaxUrls.ScheduleUrl.Add);
                }, 0);

            }

            //排序：观看人数 时间 箭头切换
            $("#vClassSeeNum").attr('onclick', 'arrowChange("vClassSeeNum","vClassSeeNumBtm","vClassSeeNumTop")');
            $("#vClassSeeTime").attr('onclick', 'arrowChange("vClassSeeTime","vClassSeeTimeBtm","vClassSeeTimeTop")');

            //查询按钮点击
            $("#query_btn").click(function () {
                var pageId = activePage();//获取当前页面标题
                var isPlayID = liveIsPlaying();//所有直播 即将开始 直播回放
                var liveMyID = liveMyCategory();//我的班课的 我看过的 我的收藏
                //观看时间的正序倒序
                var seeT = $("#vClassSeeTime").attr("class");
                var $order = (seeT == "vClassSeeTimeTop") ? 0 : 1;
                //主讲
                var teachVal = parseInt($("#listTeach").combogrid("getValues")[0]);
                if ((teachVal + '') == "NaN" && $.trim($("#listTeach").combogrid("getValue")).length != 0) {
                    Dialogue.Msg("请选择列表中的主讲人");
                    return;
                };

                //课程
                var courseVal = parseInt($("#videoCourse").combogrid("getValues")[0]);
                if ((courseVal + '') == "NaN" && $.trim($("#videoCourse").combogrid("getValue")).length != 0) {
                    Dialogue.Msg("请选择列表中的课程");
                    return;
                };
                var schoolVal;  //学校
                if ($(".schoolListWrap").length > 0) {
                    var schoolVal = parseInt($("#schoolList").combogrid("getValues")[0]);
                    if ((schoolVal + '') == "NaN" && $.trim($("#schoolList").combogrid("getValue")).length != 0) {
                        Dialogue.Msg("请选择列表中的学校");
                        return;
                    };
                };

                //年级
                var gradeVal;
                if ($(".gradeListWrap").length > 0) {
                    gradeVal = parseInt($("#gradeList").combogrid("getValues")[0]);
                    if ((gradeVal + '') == "NaN" && $.trim($("#gradeList").combogrid("getValue")).length != 0) {
                        Dialogue.Msg("请选择列表中的年级");
                        return;
                    };
                }
                //学科
                var subjectVal = parseInt($("#selectSubject").combogrid("getValues")[0]);
                if ((subjectVal + '') == "NaN" && $.trim($("#selectSubject").combogrid("getValue")).length != 0) {
                    Dialogue.Msg("请选择列表中的学科");
                    return;
                };

                refreshPage(pageId, isPlayID, liveMyID, "StartTime", $order, 1);
            });
            $("#videoTheme").keyup(function (e) {
                var vals = $(this).val();
                e.keyCode == 13 && $("#query_btn").click();
                vals.length == 0 && $("#query_btn").click();
            })
            //重置--将查询数据清空
            $("#reset_btn").click(function () {
                $dp.$("startDT1").value = "";
                $dp.$("endDT1").value = "";

                //标题
                $("#videoTheme").val("");
                //主讲
                $("#listTeach").combogrid("setValue", null);
                //课程
                $("#videoCourse").combogrid("setValue", null);

                //学校
                if ($(".schoolListWrap").length > 0) {
                    $("#schoolList").combogrid("setValue", null);
                };
                //年级
                if ($(".gradeListWrap").length > 0) {
                    $("#gradeList").combogrid("setValue", null);
                };
                //学科
                $("#selectSubject").combogrid("setValue", null);
                $("#query_btn").click();
            });

            //排序点击：所有直播 正在直播 即将开始 直播回放
            $(".allOpen-btmClick a").click(function () {
                $("#all-live").addClass("vClassTitleItemActive").siblings("a").removeClass("vClassTitleItemActive");
                $(this).addClass("vClassSelectBtmActive").siblings("a").removeClass("vClassSelectBtmActive");
                $(".my-btmClick a").removeClass("vClassSelectBtmActive");

                nowPageNumber = 1;
                if (window.location.href.indexOf("#page=") != -1) { //记录当前页码
                    Query.setHash({
                        page: nowPageNumber
                    })
                };
                var isPlayID = $(this).attr("id");//点击的所有直播 即将开始 直播回放
                //当id为即将开始，观看次数的排序选项隐藏
                if (isPlayID == "live_T") {
                    $("#vClassSeeNum").addClass("hidee");
                } else {
                    $dp.$("startDT1").value = getNowDate(null, true);
                    $("#vClassSeeNum").removeClass("hidee");
                };
                var pageId = activePage();//获取当前页面标题
                var liveMyID = liveMyCategory();//我的班课 我看过的 我的收藏
                //观看时间的正序倒序
                var seeT = $("#vClassSeeTime").attr("class");

                if (isPlayID == "live_Tall") {
                    $dp.$("startDT1").value = "";
                    $dp.$("endDT1").value = "";
                    $("#vClassSeeTime").removeClass("vClassSeeTimeTop").addClass("vClassSeeTimeBtm");
                    refreshPage(pageId, isPlayID, liveMyID, "StartTime", 1, nowPageNumber)
                } else if (isPlayID == "live_Ting") {
                    $dp.$("startDT1").value = "";
                    $dp.$("endDT1").value = "";
                    refreshPage(pageId, isPlayID, liveMyID, "StartTime", 1, nowPageNumber);
                } else if (isPlayID == "live_T") {
                    $dp.$("startDT1").value = getNowDate(null, true);
                    $dp.$("endDT1").value = "";
                    refreshPage(pageId, isPlayID, liveMyID, "StartTime", 0, nowPageNumber);
                } else {
                    $dp.$("startDT1").value = "";
                    $dp.$("endDT1").value = getNowDate(null, true);
                    refreshPage(pageId, isPlayID, liveMyID, "StartTime", 1, nowPageNumber);
                };
            });

            //排序点击：我的点赞  我的收藏
            $(".my-btmClick a").click(function () {
                $("#my-live").addClass("vClassTitleItemActive").siblings("a").removeClass("vClassTitleItemActive");
                $(this).addClass("vClassSelectBtmActive").siblings("a").removeClass("vClassSelectBtmActive");
                $(".allOpen-btmClick a").removeClass("vClassSelectBtmActive");

                nowPageNumber = 1;
                if (window.location.href.indexOf("#page=") != -1) { //记录当前页码
                    Query.setHash({
                        page: nowPageNumber
                    })
                };
                var liveMyID = $(this).attr("id");//点击的我的班课 我看过的 我的收藏
                var isPlayID = liveIsPlaying();//所有直播 即将开始 直播回放
                //观看时间的正序倒序
                var seeT = $("#vClassSeeTime").attr("class");
                var $order = (seeT == "vClassSeeTimeTop") ? 0 : 1;
                refreshPage("my-live", isPlayID, liveMyID, "StartTime", $order, nowPageNumber);
            });

            //排序点击：观看次数和开始时间的正序倒序  Order:0正序  1倒序
            $(".vClassSelectBtmOrderCxt a").click(function () {
                var pageId = activePage();//获取当前页面标题
                var isPlayID = liveIsPlaying();//所有直播 即将开始 直播回放
                var liveMyID = liveMyCategory();//我的班课的 我看过的 我的收藏
                var orderID = $(this).attr("id");
                var orderClass = $(this).attr("class");
                var $order = 1;
                if (orderID == "vClassSeeNum") {//观看次数
                    $order = (orderClass == "vClassSeeNumTop") ? 0 : $order;
                    refreshPage(pageId, isPlayID, liveMyID, "ViewTimes", $order, 1);
                } else {//开始时间vClassSeeTime
                    $order = (orderClass == "vClassSeeTimeTop") ? 0 : $order;
                    refreshPage(pageId, isPlayID, liveMyID, "StartTime", $order, 1);
                };
            });

            //分享功能
            $(".videoClassBody").delegate(".vClassSectionShareData", "click", function () {
                var ID;
                var $LiveID = $(this).parents(".vClassSectionCenter").attr("LiveID");
                var $VideoID = $(this).parents(".vClassSectionCenter").attr("VideoID");
                var $title = $(this).parents(".vClassSectionCenter").find("h4").text();
                var $videoState = $(this).attr("videostate");
                var urlTxt;
                if ($videoState == "live") {
                    ID = $LiveID;
                    urlTxt = window.location.protocol + "//" + window.location.host + "/MiYun/phoneLiveMiYun.aspx?liveID=" + ID;
                } else {
                    ID = $VideoID;
                    urlTxt = window.location.protocol + "//" + window.location.host + "/MiYun/phoneVideoMiYun.aspx?videoID=" + ID;
                };
                shareTo({
                    titles: $title,
                    urls: urlTxt
                });
            });
            //收藏和取消收藏功能     -- 必须是登录用户
            $(".videoClassBody").delegate(".vClassSectionLikeData", "click", function () {
                var self = $(this);
                if (strCookie != 0) {//用户已经登录
                    self.hasClass("vClassSectionActiveData") ? isNotCollection(self) : isCollection(self);
                } else {//没有登录跳转到登陆页
                    window.location.href = "/Login.aspx";
                };
            });

            //点赞和取消点赞功能     -- 必须是登录用户
            $(".videoClassBody").on("click", ".thumbup_wrap", function () {
                var self = $(this);
                if (strCookie != 0) {//用户已经登录
                    self.hasClass("has_thumbup") ? isNotThumbUp(self) : isThumbUp(self);
                } else {//没有登录跳转到登陆页
                    window.location.href = "/Login.aspx";
                };
            });


        });
        //进入播放页
        function enterPlayPage() {
            var _this = $(this);
            var playState = _this.parents(".videoClassSection").attr("liveplaystate");
            var $liveid = _this.parents(".videoClassSection").attr("liveid");
            var $videoid = _this.parents(".videoClassSection").attr("videoid");

            if (strCookie != 0) {
                Ajax.ajax({
                    url: AjaxUrls.LiveInfo.GetLiveInfoByID,
                    data: { LiveID: $liveid },
                    async: false
                }).done(function (item) {
                    if (item.IsLiving) {//正在直播
                        if (item.TeacherList.length > 0) {//判断当前用户是否主讲，助教
                            var isTeacher = false, isMarjorTeacher = false;
                            for (var ij = 0; ij < item.TeacherList.length; ij++) {
                                var row = item.TeacherList[ij];
                                if (row.TeacherID == userInfo[0].ID) {
                                    isTeacher = true;
                                    if (row.IsMajor) {
                                        isMarjorTeacher = true;
                                    };
                                    break;
                                };
                            };
                            if (isMarjorTeacher) {//登陆用户是主讲
                                if (_this.find("div").hasClass("start_exe_now")) {//打开客户端
                                    openMiYunExe($liveid);
                                } else {
                                    openNewPage("/MiYun/LiveShow.aspx?liveID=" + $liveid);
                                };
                            } else {
                                openNewPage("/MiYun/LiveShow.aspx?liveID=" + $liveid);
                            };
                        };
                    } else {
                        if (!item.IsLiveCompleted) {//直播未开始
                            //课程开始时间和结束时间
                            var courseStartT = item.StartTime;
                            var courseEndT = item.StopTime;

                            var courseEndTPie = courseEndT.split(" ");
                            var courseEndTPieStart = courseEndTPie[0].split("-");
                            var courseEndTPieEnd = courseEndTPie[1].split(":");
                            var overTimeEnd = new Date() - new Date(courseEndTPieStart[0], (courseEndTPieStart[1] - 1), courseEndTPieStart[2], courseEndTPieEnd[0], courseEndTPieEnd[1], courseEndTPieEnd[2]);

                            var courseStartPie = courseStartT.split(" ");
                            var courseStartPieStart = courseStartPie[0].split("-");
                            var courseStartPieEnd = courseStartPie[1].split(":");
                            var overTimeStart = new Date() - new Date(courseStartPieStart[0], (courseStartPieStart[1] - 1), courseStartPieStart[2], courseStartPieEnd[0], courseStartPieEnd[1], courseStartPieEnd[2]);

                            if (overTimeStart < 0 || (overTimeStart > 0 && overTimeEnd < 0)) {//直播未开始
                                //  if (strCookie != 0 || (UserType == 1 || UserType == 2)) {//用户已经登录--判断用户类型是否为系统管理员（状态等同未登录）//教师 学生
                                if (item.TeacherList.length > 0) {
                                    var isTeacher = false, isMarjorTeacher = false;
                                    for (var ij = 0; ij < item.TeacherList.length; ij++) {
                                        var row = item.TeacherList[ij];
                                        if (row.TeacherID == userInfo[0].ID) {
                                            isTeacher = true;
                                            if (row.IsMajor) {
                                                isMarjorTeacher = true;
                                            };
                                            break;
                                        };
                                    };

                                    if (isMarjorTeacher && isTeacher) {//登陆用户是主讲
                                        if (_this.find("div").hasClass("start_live_now")) {//打开客户端,开启直播
                                            openMiYunExe($liveid);
                                        } else {
                                            openNewPage("/MiYun/LiveShow.aspx?liveID=" + $liveid);
                                        };
                                    } else if (!isMarjorTeacher && isTeacher) {//登陆用户是助教
                                        openNewPage("/MiYun/LiveShow.aspx?liveID=" + $liveid);
                                    } else {//除了主讲和助教之外的
                                        Dialogue.Msg("直播未开始！");
                                    };
                                };
                            } else {//直播过期
                                Dialogue.Msg("直播已过期！");
                            };
                        } else if (item.IsLiveCompleted) {
                            if (item.VideoID == 0) {
                                Dialogue.Msg("直播已结束！");
                            } else if (item.IsRecordCompleted) {//直播回放
                                $videoid != 0 ? openNewPage("/MiYun/Video.aspx?VideoID=" + $videoid) : Dialogue.Msg(title);
                            };
                        };
                    };
                })
            };
        }
        ///打开客户端
        function openMiYunExe($liveid) {
            Ajax.ajax({
                url: AjaxUrls.UserUrls.GetCurrentAccessToken
            }).done(function (data) {
                var domain = window.location.protocol + "//" + window.location.host;
                window.location.href = "PowerCreator://" + $liveid + "|" + data + "|" + domain+"|"+(new Date()).valueOf();
                layer.closeAll();
            }).fail(function (data) {
                Dialogue.Error(data);
            })
        }

        //取消点赞//点赞和取消点赞功能
        function isNotThumbUp(self) {
            var LiveID = self.parents(".vClassSectionCenter").attr("LiveID");
            var Num = self.find(".CollectedNum").html();
            var newCount = parseInt(parseInt(Num) - 1);

            Ajax.ajax({
                url: AjaxUrls.LiveInfo.CancelLikeLive,
                data: { LiveID: LiveID },
            }).done(function (data) {
                Dialogue.Success("取消成功");
                self.removeClass("has_thumbup").addClass("no_thumbup");
                self.find(".CollectedNum").html(newCount);
            }).fail(function (data) {
                Dialogue.Error(data);
            })
        }

        //点赞
        function isThumbUp(self) {
            var LiveID = self.parents(".vClassSectionCenter").attr("LiveID");
            var Num = self.find(".CollectedNum").html();
            var newCount = parseInt(parseInt(Num) + 1);
            Ajax.ajax({
                url: AjaxUrls.LiveInfo.LikeLive,
                data: { LiveID: LiveID },
            }).done(function (data) {
                Dialogue.Success("点赞成功");
                self.removeClass("no_thumbup").addClass("has_thumbup");
                self.find(".CollectedNum").html(newCount);
            }).fail(function (data) {
                Dialogue.Error(data);
            })
        }



        //根据页面标题和查询项 刷新页面 （点击页面标题或者点击查询按钮）
        function refreshPage(page_id, isPlayID, liveMyID, $Sort, $Order, pageNumber) {
            var startD = $dp.$("startDT1").value;
            var endD = $dp.$("endDT1").value;
            var courseVal = '';
            //标题
            var themeVal = $("#videoTheme").val();
            //主讲
            if (!$(".teacherWrap ").is(":hidden")) {
                var teachVal = $("#listTeach").combogrid("getValues")[0];
            };
            //课程
            if (!$(".courseListWrap").is(":hidden")) {
                courseVal = $("#videoCourse").combogrid("getValues")[0];
            };
            //教室
            var croomVal = '';
            //院系专业组织机构
            var organVal = '';
            //节次
            var NodeID = "";
            //学校
            var schoolVal = "";
            if ($(".schoolListWrap").length > 0) {
                schoolVal = $("#schoolList").combogrid("getValues")[0];
            };
            //年级
            if (!$(".gradeListWrap").is(":hidden") && $(".gradeListWrap").length > 0) {
                var gradeVal = $("#gradeList").combogrid("getValues")[0];
            };
            //学科
            var subjectVal = $("#selectSubject").combogrid("getValues")[0];

            if (page_id == "all-live") {//所有直播
                if (isPlayID == "live_Ting") {//正在直播
                    showLiveList(schoolVal, gradeVal, subjectVal, "10", pageNumber, "0", themeVal, NodeID, teachVal, null, organVal, courseVal, croomVal, null, endD, null, true, null, null, false, null, "StartTime", $Order);
                } else if (isPlayID == "live_T") {//即将开始
                    showLiveList(schoolVal, gradeVal, subjectVal, "10", pageNumber, "0", themeVal, NodeID, teachVal, null, organVal, courseVal, croomVal, null, endD, null, false, null, null, false, null, $Sort, $Order, (getNowDate(null)).split(" ")[0]);
                } else if (isPlayID == "live_Ted") {//直播回放 点播数据 还没有
                    showLiveList(schoolVal, gradeVal, subjectVal, "10", pageNumber, "0", themeVal, NodeID, teachVal, null, organVal, courseVal, croomVal, startD, endD, null, false, null, null, true, true, $Sort, $Order);
                } else {//所有直播数据
                    showLiveList(schoolVal, gradeVal, subjectVal, "10", pageNumber, "0", themeVal, NodeID, teachVal, null, organVal, courseVal, croomVal, startD, endD, null, null, null, null, null, null, $Sort, $Order);
                };
            } else if (page_id == "my-live") {//与我相关
                if (liveMyID == "live_have") {//我的班课
                    //获取用户类型UserType
                    var uType = userData.UserType;
                    if (uType == 1) {//教师
                        //主讲
                        $("#listTeach").combogrid("setValue", { TeacherID: userData.ID, TeacherName: userData.Name });
                        showLiveList(schoolVal, gradeVal, subjectVal, "10", pageNumber, "0", themeVal, NodeID, userData.ID, null, organVal, courseVal, croomVal, startD, endD, null, null, null, null, null, null, $Sort, $Order);
                    } else if (uType == 2) {//学生
                        showLiveList(schoolVal, gradeVal, subjectVal, "10", pageNumber, "0", themeVal, NodeID, teachVal, userData.ID, organVal, courseVal, croomVal, startD, endD, null, null, null, null, null, null, $Sort, $Order);
                    };
                } else if (liveMyID == "live_see") {//我看过的
                    showLiveList(schoolVal, gradeVal, subjectVal, "10", pageNumber, "0", themeVal, NodeID, null, null, organVal, courseVal, croomVal, startD, endD, null, null, userData.ID, null, null, null, $Sort, $Order);
                } else if (liveMyID == "live_save") {//我的收藏
                    showLiveList(schoolVal, gradeVal, subjectVal, "10", pageNumber, "0", themeVal, NodeID, null, null, organVal, courseVal, croomVal, startD, endD, null, null, null, userData.ID, null, null, $Sort, $Order);
                } else if (liveMyID == "live_like") {
                    showLiveList(schoolVal, gradeVal, subjectVal, "10", pageNumber, "0", themeVal, NodeID, null, null, organVal, courseVal, croomVal, startD, endD, null, null, null,null, null, null, $Sort, $Order, null, null, null, userData.ID);
                };
            } else {//公开直播
                if (isPlayID == "live_Ting") {//正在直播
                    showLiveList(schoolVal, gradeVal, subjectVal, "10", pageNumber, "0", themeVal, NodeID, teachVal, null, organVal, courseVal, croomVal, startD, endD, true, true, null, null, false, null, $Sort, $Order);
                } else if (isPlayID == "live_T") {//即将开始
                    showLiveList(schoolVal, gradeVal, subjectVal, "10", pageNumber, "0", themeVal, NodeID, teachVal, null, organVal, courseVal, croomVal, startD, endD, true, false, null, null, false, null, $Sort, $Order, (getNowDate(null)).split(" ")[0]);
                } else if (isPlayID == "live_Ted") {//直播回放
                    showLiveList(schoolVal, gradeVal, subjectVal, "10", pageNumber, "0", themeVal, NodeID, teachVal, null, organVal, courseVal, croomVal, startD, endD, true, false, null, null, true, true, $Sort, $Order);
                } else {
                    showLiveList(schoolVal, gradeVal, subjectVal, "10", pageNumber, "0", themeVal, NodeID, teachVal, null, organVal, courseVal, croomVal, getNowDate(null, true), endD, true, null, null, null, null, null, $Sort, $Order);
                };
            };

            clearInterval(timerArr);
            timerArr = setInterval(function () {
                var remaintimeList = $(".videoClassBody .distance_to_live_start_time");
                if (remaintimeList == 0) {
                    clearInterval(timerArr);
                };
                $.each(remaintimeList, function (index, obj) {
                    var remainTimeNum = $(obj).attr("remainTime");
                    var nowShow = changeTime(toChangeSeconds(remainTimeNum) - 1);
                    if (nowShow == '00:00:00' || typeof nowShow == 'undefined') {
                        $(obj).remove();
                        return;
                    };
                    $(obj).attr("remainTime", nowShow);
                    $(obj).html("距离直播开始：" + nowShow);
                })
            }, 1000)
        };

        function showLiveList(schoolVal, gradeVal, subjectVal, PageSize, PageNum, $LiveID, txt, NodeID, $TeacherID, $StudentID, $OrganizationID, $CourseID, $ClassroomID, $StartTime, $StopTime, $IsPublic, $IsLiving, $ViewerID, $CollectorID, $IsCompleted, $IsNeedRecord, $Sort, $Order, $MinStartTime, $MinStopTime, isPageNumChange, LikerID) {
            if (window.location.href.indexOf("#page=") != -1) { //记录当前页码
                PageNum = window.location.href.split("#page=")[1];
            } else {
                PageNum = nowPageNumber;
            };
            if (window.sessionStorage.getItem("cloudSystemNowPageSize")) {//记录当前页大小
                PageSize = window.sessionStorage.getItem("cloudSystemNowPageSize");
            };
            Ajax.ajax({
                url: AjaxUrls.MiYun.LiveQuery,//SchoolID:schoolVal || userInfo[0].SchoolID
                data: { SchoolID: "", SubjectID: subjectVal, GradeID: gradeVal, PageSize: PageSize, PageNumber: PageNum, LiveID: $LiveID, TitleKey: txt, NodeID: NodeID, TeacherID: $TeacherID, StudentID: $StudentID, OrganizationID: $OrganizationID, CourseID: $CourseID, ClassroomID: $ClassroomID, StartDate: $StartTime, StopDate: $StopTime, IsPublic: $IsPublic, IsLiving: $IsLiving, ViewerID: $ViewerID, CollectorID: $CollectorID, IsCompleted: $IsCompleted, IsNeedRecord: $IsNeedRecord, Sort: $Sort, Order: $Order, MinStartTime: $MinStartTime, MinStopTime: $MinStopTime, LikerID: LikerID },
            }).done(function (data) {
                if (data.Data.length == 0 && data.TotalCount > 0) {
                    PageNum = Math.ceil(data.TotalCount / PageSize);
                    nowPageNumber = PageNum;
                    Query.setHash({
                        page: PageNum
                    });
                    showLiveList(schoolVal, gradeVal, subjectVal, PageSize, PageNum, $LiveID, txt, NodeID, $TeacherID, $StudentID, $OrganizationID, $CourseID, $ClassroomID, $StartTime, $StopTime, $IsPublic, $IsLiving, $ViewerID, $CollectorID, $IsCompleted, $IsNeedRecord, $Sort, $Order, $MinStartTime, $MinStopTime, isPageNumChange);
                    return;
                };

                if (data.TotalCount > 0) {//如果存在数据
                    $("#tips").empty();
                    var html = "";
                    for (var m = 0; m < data.Data.length; m++) {
                        var living = "", recorded = "";
                        var item = data.Data[m];
                        var Datestart = item.StartTime.split(" ");//["2017-08-04", "00:00:00"]
                        var start_time = Datestart[1].substr(0, 5);
                        var start_date = Datestart[0].split("-")[1] + "." + Datestart[0].split("-")[2];
                        var date_arr = Datestart[0].split("-");
                        var newStart = new Date(date_arr[0], date_arr[1] - 1, date_arr[2]);
                        var start_week = weekName[newStart.getDay()];

                        //课程开始时间和结束时间
                        var courseStartT = item.StartTime;
                        var courseEndT = item.StopTime;
                        //直播状态
                        var liveStateHtml = "", livePlayState = "", QRpicture = "", isHaveShare = "", distanceToLiveStartTime = '';
                        if (item.IsLiving) {
                            if (strCookie != 0 || (UserType == 1 || UserType == 2)) {//用户已经登录--判断用户类型是否为系统管理员（状态等同未登录）//教师 学生
                                if (item.TeacherList.length > 0) {
                                    var isTeacher = false;
                                    for (var ij = 0; ij < item.TeacherList.length; ij++) {
                                        if ((item.TeacherList[ij].TeacherID == userInfo[0].ID) && (item.TeacherList[ij].IsMajor) && UserType == 1) {
                                            isTeacher = true;
                                            break;
                                        };
                                    };
                                    liveStateHtml = isTeacher ? "<div class='start_exe_now' liveid='" + item.LiveID + "' scheduleid='" + item.ScheduleID + "'>打开客户端</div>" : "<div>观看直播</div>";
                                } else {
                                    //没设置主讲助教，再来比较创建人
                                    liveStateHtml = item.CreatorID == userInfo[0].UserID ? "<div class='start_exe_now'  liveid='" + item.LiveID + "'  scheduleid='" + item.ScheduleID + "'>打开客户端</div>" : "<div>观看直播</div>";
                                };
                            } else {
                                liveStateHtml = "<div>正在直播</div>";
                            };

                            livePlayState = "playing";
                            var imagePath = window.location.protocol + "//" + window.location.host + "/MiYun/phoneLiveMiYun.aspx?liveID=" + item.LiveID;
                            QRpicture = '<p>扫码观看</p><a href="livelist.htm#"><img src="http://miyun.smartclass.cn/DeliveryClass/GetQrCode?CodeText='%20+%20imagePath%20+%20'" style="width:100px;height:100px;" /></a>';
                            isHaveShare = ' | ' +
                                '<a class="vClassSectionShareData" href="javascript:void(0)" videoState = "live">分享</a>';//分享添加弹窗--分享到微博 微信 qq
                        } else {
                            if (!item.IsLiveCompleted) {//直播未开始
                                var courseEndTPie = courseEndT.split(" ");
                                var courseEndTPieStart = courseEndTPie[0].split("-");
                                var courseEndTPieEnd = courseEndTPie[1].split(":");
                                var overTimeEnd = new Date() - new Date(courseEndTPieStart[0], (courseEndTPieStart[1] - 1), courseEndTPieStart[2], courseEndTPieEnd[0], courseEndTPieEnd[1], courseEndTPieEnd[2]);

                                var courseStartPie = courseStartT.split(" ");
                                var courseStartPieStart = courseStartPie[0].split("-");
                                var courseStartPieEnd = courseStartPie[1].split(":");
                                var overTimeStart = new Date() - new Date(courseStartPieStart[0], (courseStartPieStart[1] - 1), courseStartPieStart[2], courseStartPieEnd[0], courseStartPieEnd[1], courseStartPieEnd[2]);

                                if (overTimeStart < 0 || (overTimeStart > 0 && overTimeEnd < 0)) {
                                    if (strCookie != 0 || (UserType == 1 || UserType == 2)) {//用户已经登录--判断用户类型是否为系统管理员（状态等同未登录）//教师 学生
                                        if (item.TeacherList.length > 0) {
                                            var isTeacher = false;
                                            for (var ij = 0; ij < item.TeacherList.length; ij++) {
                                                if (item.TeacherList[ij].TeacherID == userInfo[0].ID && (item.TeacherList[ij].IsMajor) && UserType == 1) {
                                                    isTeacher = true;
                                                    break;
                                                };
                                            };
                                            liveStateHtml = isTeacher ? "<div class='start_live_now' liveid='" + item.LiveID + "' scheduleid='" + item.ScheduleID + "'>进入课堂</div>" : "<div>直播未开始</div>";
                                        } else {
                                            //没设置主讲助教，再来比较创建人
                                            liveStateHtml = item.CreatorID == userInfo[0].UserID ? "<div class='start_live_now'  liveid='" + item.LiveID + "'  scheduleid='" + item.ScheduleID + "'>进入课堂</div>" : "<div>直播未开始</div>";
                                        };
                                        var compareTime = compareTimes_different(item.StartTime, getNowTimes());
                                        if (compareTime > 0) {
                                            var remainTime = changeTime(compareTime / 1000);
                                            distanceToLiveStartTime = '<li class="distance_to_live_start_time" remainTime=' + remainTime + '>距离直播开始：' + remainTime + '</li>';
                                        };
                                    } else {
                                        liveStateHtml = "<div>直播未开始</div>";
                                    };
                                    livePlayState = "noplay";
                                } else {
                                    liveStateHtml = "<div class='living_end_overdate'>直播已过期</div>";
                                    livePlayState = "overdate";
                                };
                            } else if (item.IsLiveCompleted) {//直播回放item.IsLiveCompleted == true && item.IsRecordCompleted == true
                                //如果是直播回放且vedioID=0,不添加直播回放的链接，按钮隐藏
                                if (item.VideoID == 0) {
                                    liveStateHtml = "<div class='living_end_overdate'>直播已结束</div>";
                                    livePlayState = "playend";
                                } else {
                                    livePlayState = "playback";
                                    liveStateHtml = "<div>直播回放</div>";

                                    urlTxt = window.location.protocol + "//" + window.location.host + "/MiYun/phoneVideoMiYun.aspx?videoID=" + item.VideoID;

                                    //QRpicture = '<p>扫码观看</p><a href="livelist.htm#"><img src="http://miyun.smartclass.cn/DeliveryClass/GetQrCode?CodeText='%20+%20urlTxt%20+%20'" style="width:100px;height:100px;" /></a>';
                                    QRpicture = "";
                                    //isHaveShare = ' | ' +
                                    //            '<a class="vClassSectionShareData" href="javascript:void(0)" videoState = "video">分享</a>';//分享添加弹窗--分享到微博 微信 qq
                                    isHaveShare = "";
                                };
                            };
                        };
                        //是否收藏
                        var IsCollectedClass = "";
                        IsCollectedClass = (item.IsCollected ? "vClassSectionActiveData" : "");

                        //是否点赞
                        var IsSubupClass = ""
                        IsSubupClass = (item.IsLiked ? "has_thumbup" : "no_thumbup");

                        //是否加密
                        var isPWD = "", passwordHtml = '';
                        isPWD = ((item.LivePassword == "" || item.LivePassword == null) ? "no" : "yes");
                        if (isPWD == "no") {
                            passwordHtml = '<b ispwd="' + isPWD + '" class="vClassSectionRightSecret vClassSectionRightSecretNo">未加密</b></p>'
                        } else {
                            passwordHtml = '<b ispwd="' + isPWD + '" class="vClassSectionRightSecret vClassSectionRightSecretYes">已加密</b></p>'
                        };
                        //班级
                        var liveClassArr = item.OwnerClasses;
                        var liveClassHtml = "";
                        if (liveClassArr.length > 0) {
                            for (var i = 0; i < liveClassArr.length; i++) {
                                liveClassHtml += liveClassArr[i].ClassName + " ";
                            };
                        };

                        var memoHtml = '';

                        var maintTacher = "";
                        if (item.TeacherList.length == 0) {
                            maintTacher = "主讲未知";
                        } else {
                            $(item.TeacherList).each(function (n, obj) {
                                n == item.TeacherList.length - 1 ? (maintTacher += obj.TeacherName) : (maintTacher += obj.TeacherName + ',');
                            })
                        };

                        var nofindPic = "'/images/videoClassImg/videoCourse_01.png'";
                        var defaultImg = item.ImageUri || "/images/videoClassImg/videoCourse_01.png";
                        var Grades = "", GradesArr = [];
                        if (item.Grades) {
                            for (var i = 0; i < item.Grades.length; i++) {
                                GradesArr.push(item.Grades[i].GradeName);
                            }
                            Grades = GradesArr.join("，");
                        }
                        html += '<div VideoID="' + item.VideoID + '" livePlayState="' + livePlayState + '" SchoolID="' + item.SchoolID + '" ScheduleID="' + item.ScheduleID + '" LiveID="' + item.LiveID + '" class="videoClassSection liveClass_Article clearFloat">' +
                                '<div LiveID="' + item.LiveID + '" class="vClassSectionLeft">' +
                                '<a class="imgClick" href="javascript:void(0)"><img src="http://miyun.smartclass.cn/miyun/'%20+%20defaultImg%20+%20'" onerror="nofindPic(' + nofindPic + ',null,event)"/></a>' +
                                '<div class="vClassLeftOpacity">' +
                                '<div class="vClassLeftOpacityBg">' +
                                '<p class="vClassLeftOpacityBgTop"></p>' +
                                '<p class="vClassLeftOpacityBgBtm"></p>' +
                                '</div>' +
                                '<div class="vClassLeftOpacityCxt">' +
                                '<h4 class="vClassLeftOpacityCxtTop">' + start_date + '</h4>' +//开始日期
                                '<h4 class="vClassLeftOpacityCxtBtm">' + start_week + '</h4>' +//开始星期
                                '</div>' +
                                '</div>' +
                                '</div>' +
                                '<div LiveID="' + item.LiveID + '" VideoID="' + item.VideoID + '" class="vClassSectionCenter">' +
                                '<a class="h4Click" href="javascript:void(0)"><h4>' + (item.Title || "暂无标题") + '</h4></a>' +//课程标题
                                '<ul class="vClassSectionContent clearFloat">' +
                                '<li class="vClassSectionPhoto"></li>' +
                                '<li class="vClassSectionInfo">' +
                                '<p class="vClassSectionUserInfo">' +
                                '<span>' + maintTacher + '</span>' +//教师名称 王明
                                '<span CourseID="' + item.CourseID + '">' + (item.CourseName || "课程名称暂无") + '</span>' +//课程名称
                                '<span>' + (Grades || "年级暂无") + '</span></p>' +//年级名称
                                '<p class="lClassSectionTimeInfo">' +
                                '<span class="vClassSectionTimeDate">' + courseStartT + '</span>' +//开始时间
                                '<span>' + courseEndT + '</span></p>' +//结束时间
                                '<p class="lClassSectionAddrInfo">' +
                                //'<span class="lClassSectionAddrArea">' + (item.TeachingBuildingName || "") + '</span><span>' + (item.ClassRoomName || "") + '</span></p>' +//教学楼 教室
                                '</li></ul>' +
                                '<div class="vClassSectionOutData hidee">' +//直播未开始
                                '<a class="vClassSectionLikeData ' + IsCollectedClass + '" href="javascript:void(0)">收藏（<span class="CollectedNum">' + item.CollectorsCount + '</span>人）</a>' +//未开始收藏数
                                '</div>' +
                                '<div class="vClassSectionData">' +//观看直播 直播回放
                                '<a class="vClassSectionSeeData" href="javascript:void(0)">' + item.ViewTimes + ' 已观看</a>' +//观看数
                                ' | ' +
                                '<a class="vClassSectionLikeData ' + IsCollectedClass + '" href="javascript:void(0)">收藏（<span class="CollectedNum">' + item.CollectorsCount + '</span>人）</a>' +//收藏数
                                ' | ' +
                                '<a class="thumbup_wrap ' + IsSubupClass + '" href="javascript:void(0)">点赞（<span class="CollectedNum">' + item.LikersCount + '</span>人）</a>' +//点赞数
                                ' | ' +
                                '<a class="vClassSectionCommentData" href="javascript:void(0)">评论（' + item.CommentsCount + '）</a>' +//评论数
                                isHaveShare +
                                '</div></div>' +
                                '<div LiveID="' + item.LiveID + '" class="vClassSectionRight"><ul class="lClassSectionPlayInfo clearFloat">' + distanceToLiveStartTime +

                                '<li class="lClassSectionIsStart"><p class="lClassSectionStartTime clearFloat">' +
                                '<span>' + start_time + '</span>' +
                               passwordHtml +
                                '<a href="javascript:void(0)" class="liveStateA">' + liveStateHtml + '</a>' +//直播未开始 观看直播 直播回放 状态liveStateHtml
                                '<li class="lClassSectionQRcode">' + QRpicture +
                                '</li></ul>' +
                                '</div>' +
                                '</div>';
                    };
                    $(".videoClassBody").empty().append(html);



                    //加密的显示与隐藏
                    //var $pwdEles = $(".videoClassBody .vClassSectionRightSecret");
                    //$.each($pwdEles, function (index, ele) {
                    //    var isPWD = $(ele).attr("ispwd");
                    //    if (isPWD == "no") {
                    //        $(ele).css("display", "none");
                    //    } else {
                    //        $(ele).css("display", "inline-block");
                    //    };
                    //});
                    //直播数据状态
                    var $liveLists = $(".videoClassBody .videoClassSection");
                    $.each($liveLists, function (index, ele) {
                        var playState = $(ele).attr("liveplaystate");
                        var video_id = $(ele).attr("videoid");
                        if (playState == "noplay") {//直播未开始
                            $(ele).find(".liveStateA div").addClass("lClassSectionStartTimeNo");//直播未开始
                            $(ele).find(".vClassSectionOutData").css("display", "block");//收藏 分享
                            $(ele).find(".vClassSectionData").css("display", "none");//观看收藏评论分享
                        } else if (playState == "playing") {//正在直播
                            $(ele).find(".liveStateA div").addClass("see_living_stream");//观看直播
                            $(ele).find(".vClassSectionData").css("display", "block");//观看收藏评论分享
                            $(ele).find(".vClassSectionOutData").css("display", "none");//收藏 分享
                        } else if (playState == "playback") {//直播回放
                            video_id != 0 ? $(ele).find(".liveStateA div").attr("class", "") : $(ele).find(".liveStateA div").attr("class", "lClassSectionStartTimeNo");//直播回放或直播回放资源准备中
                            $(ele).find(".vClassSectionData").css("display", "block");//观看收藏评论分享
                            $(ele).find(".vClassSectionOutData").css("display", "none");//收藏 分享
                        };
                    });

                    //分页处理
                    if (data.TotalCount > PageSize) {
                        $("#pageToolbar").empty();
                        $('#pageToolbar').Paging({
                            current: PageNum, pagesize: PageSize, count: data.TotalCount, toolbar: true, callback: function (page, size, count) {
                                showLiveList(schoolVal, gradeVal, subjectVal, size, page, $LiveID, txt, NodeID, $TeacherID, $StudentID, $OrganizationID, $CourseID, $ClassroomID, $StartTime, $StopTime, $IsPublic, $IsLiving, $ViewerID, $CollectorID, $IsCompleted, $IsNeedRecord, $Sort, $Order, $MinStartTime, $MinStopTime, true);
                            }
                        });
                    } else {
                        $("#pageToolbar").empty();
                    };
                } else { //如果一条数据都没有
                    $("#pageToolbar").empty();
                    $(".videoClassBody").empty();
                    $IsLiving ? $("#tips").empty().append("暂无正在直播的数据").css("text-align", "center") : $("#tips").empty().append("暂无相关数据").css("text-align", "center");
                };
            }).fail(function (data) {
                Dialogue.Error(data);
            })
        };

        //取消收藏
        function isNotCollection(self) {
            var $LiveID = self.parents(".vClassSectionCenter").attr("LiveID");
            var $CollectedNumStr = self.find(".CollectedNum").html();
            var $CollectedNum = parseInt(parseInt($CollectedNumStr) - 1);

            Ajax.ajax({
                url: AjaxUrls.LiveInfo.CanelCollectLive,
                data: { LiveID: $LiveID }
            }).done(function (data) {
                Dialogue.Success("取消收藏成功");
                self.removeClass("vClassSectionActiveData");
                self.find(".CollectedNum").html($CollectedNum);
            }).fail(function (data) {
                Dialogue.Error(data);
            })
        }

        //收藏
        function isCollection(self) {
            var $LiveID = self.parents(".vClassSectionCenter").attr("LiveID");
            var $CollectedNumStr = self.find(".CollectedNum").html();
            var $CollectedNum = parseInt(parseInt($CollectedNumStr) + 1);

            Ajax.ajax({
                url: AjaxUrls.LiveInfo.CollectLive,
                data: { LiveID: $LiveID },
            }).done(function (data) {
                Dialogue.Success("收藏成功");
                self.addClass("vClassSectionActiveData");
                self.find(".CollectedNum").html($CollectedNum);
            }).fail(function (data) {
                Dialogue.Error(data);
            })
        }

        //获取当前页面标题
        function activePage() {
            var pageId = "";
            var $titles = $(".videoClassTitleCxt a");
            $.each($titles, function (index, ele) {
                if ($(ele).hasClass("vClassTitleItemActive")) {
                    pageId = $(ele).attr("id");
                }
            });
            return pageId;
        }
        //获取排序筛选 正在直播 即将开始 直播回放
        function liveIsPlaying() {
            var liveTid = "";
            var $titles = $(".allOpen-btmClick a");
            $.each($titles, function (index, ele) {
                if ($(ele).hasClass("vClassSelectBtmActive")) {
                    liveTid = $(ele).attr("id");
                }
            });
            return liveTid;
        }
        //获取排序筛选 我的班课 我看过的 我的收藏
        function liveMyCategory() {
            var categoryId = "";
            var $titles = $(".my-btmClick a");
            $.each($titles, function (index, ele) {
                if ($(ele).hasClass("vClassSelectBtmActive")) {
                    categoryId = $(ele).attr("id");
                }
            });
            return categoryId;
        }
    </script>
    <script type="text/javascript" src="http://miyun.smartclass.cn/Js/ScheduleLiveRecord.js"></script>
    <script type="text/javascript" src="http://miyun.smartclass.cn/Js/plug-in/uploadImg-master/uploadImg.js"></script>
    <script type="text/javascript" src="http://miyun.smartclass.cn/Js/plug-in/jquery.cookie.js"></script>


        <script>
            $(function () {
                if (strCookie && (strCookie != 0) && (userInfo[0].UserType == 1)) {
                    //secondNav();//二级菜单赋值
                    $(".webNavWrap .Statistics").show();
                    $(".first_nav_img").show();
                    $(".fheader  .personal_space").show();
                    $(".enter_backstage").show();
                } else if (strCookie && (strCookie != 0) && (userInfo[0].UserType == 0)) {
                    $(".webNavWrap .Statistics").show();
                    $(".enter_backstage").show();
                } else {
                    $(".webNavWrap .Statistics").hide();
                    $(".fheader  .personal_space").hide();
                    $(".enter_backstage").hide();
                };
            })
        </script>
    </div>
    <div class="publicFooter">
        <div class="publicContainer">
            <ul class="publicFootInfo clearfix">
                <li>
                    <img src="http://miyun.smartclass.cn/Images/miyun/miyun_logo.png" class="footImg" /><span class="copyright">©2015-2020 All Rights Reserved 密云教委·版权所有</span></li>
                <li>地址：北京市密云区新南路103号 密云区教育委员会 　邮编：101500</li>
            </ul>
        </div>
    </div>
    <script>
        $(function () {
            var i = 0;
            setInterval(function () {
                i++;
                if (i % 4 == 1) {
                    $('.blackboard').css({
                        "transform": "rotate(10deg)",
                        "transition": "2s ease-in-out"
                    });
                } else if (i % 4 == 3) {
                    $('.blackboard').css({
                        "transform": "rotate(-10deg)",
                        "transition": "2s ease-in-out"
                    });
                }
            }, 1000);
            $(".onlinePhone b").click(function () {
                $(".closeOnlinePhone").show();
                $(".blackboard").show();
            });
            $(".closeOnlinePhone").click(function () {
                $(this).hide();
                $(".blackboard").hide();
            });
        });
    </script>
</body>
</html>
